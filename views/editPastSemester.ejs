<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Semester</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body style="background-color: #ede7f6">
  <nav class="navbar navbar-expand-sm" style="background-color: #3f51b5;">
    <div class="container-fluid">
      <a class="navbar-brand" href="/dashboard" style="color:white"><b>GPA Tracker</b></a>
    </div>
  </nav> <br>

  <div class="container">
    <br>
    <form action="/editPastSemester/<%= semesterId %>" method="POST">
      
      <!-- Semester name (optional to update) -->
      <div class="row g-4">
        <div class="col-auto text-center">
          <label for="semester">Semester Name:</label>
        </div>
        <div class="col-auto">
          <select id="semester" name="semester" required>
            <option value="Y1S1" <%= semester === "Y1S1" ? "selected" : "" %>>Y1S1</option>
            <option value="Y1S2" <%= semester === "Y1S2" ? "selected" : "" %>>Y1S2</option>
            <!-- Add more if needed -->
          </select>
        </div>
      </div>
      <br>

      <button class="btn" type="button" id="add-module-btn" style="background-color: #3f51b5; color:white">Add Module +</button>
      <br><br><br>

      <div id="module-container">
        <% modules.forEach((module, index) => { %>
          <div class="module-group row g-4">

            <!-- Hidden module ID for backend -->
            <input type="hidden" name="moduleId[]" value="<%= module.moduleId %>">

            <!-- Module Name -->
            <div class="col-auto text-center">
              <label>Module Name</label><br><br>
              <input type="text" name="module[]" value="<%= module.module %>" required><br><br>
            </div>

            <!-- Code -->
            <div class="col-auto text-center">
              <label>Module Code</label><br><br>
              <input type="text" name="code[]" value="<%= module.code %>" required><br><br>
            </div>

            <!-- Grade -->
            <div class="col-auto text-center">
              <label>Final Grade</label><br><br>
              <select name="grade[]" required>
                <option <%= module.grade === "A" ? "selected" : "" %>>A</option>
                <option <%= module.grade === "B+" ? "selected" : "" %>>B+</option>
                <option <%= module.grade === "B" ? "selected" : "" %>>B</option>
                <option <%= module.grade === "C+" ? "selected" : "" %>>C+</option>
                <option <%= module.grade === "C" ? "selected" : "" %>>C</option>
                <option <%= module.grade === "D+" ? "selected" : "" %>>D+</option>
                <option <%= module.grade === "D" ? "selected" : "" %>>D</option>
                <option <%= module.grade === "F" ? "selected" : "" %>>F</option>
                <option <%= module.grade === "Pass" ? "selected" : "" %>>Pass</option>
              </select>
            </div>

            <!-- Credits -->
            <div class="col-auto text-center">
              <label>Module Credits</label><br><br>
              <input type="number" class="text-center" name="credits[]" value="<%= module.credits %>" min="1" max="6" required><br><br>
            </div>

            <!-- Delete -->
            <div class="col-auto">
              <button class="btn btn-sm delete-module-btn" type="button" style="background-color: #3f51b5; color:white;">Delete</button>
            </div>

          </div>
        <% }) %>
      </div>

      <br><br>
      <button class="btn" type="submit" style="background-color: #3f51b5; color:white">Save</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const addButton = document.getElementById('add-module-btn');
      const container = document.getElementById('module-container');

      function bindDeleteButtons() {
        const deleteButtons = container.querySelectorAll('.btn[type="button"]');
        deleteButtons.forEach(button => {
          button.removeEventListener('click', deleteHandler);
          button.addEventListener('click', deleteHandler);
        });
      }

      function deleteHandler(event) {
        const confirmed = confirm("Are you sure you want to delete this module?");
        if (!confirmed) return;

        const allGroups = container.querySelectorAll('.module-group');
        if (allGroups.length <= 1) {
          alert("At least one module is required.");
          return;
        }

        const moduleGroup = event.target.closest('.module-group');
        if (moduleGroup) {
          container.removeChild(moduleGroup);
        }
      }

      addButton.addEventListener('click', () => {
        const moduleGroups = container.querySelectorAll('.module-group');
        const lastGroup = moduleGroups[moduleGroups.length - 1];

        const requiredInputs = lastGroup.querySelectorAll('input:not([type="hidden"]), select');
        let filled = true;
        requiredInputs.forEach(input => {
        if (input.value.trim() === '') filled = false;
        });

        if (!filled) {
          alert('Please fill in all fields before adding another module.');
          return;
        }

        const clone = lastGroup.cloneNode(true);
        clone.querySelectorAll('input, select').forEach(input => {
          if (input.name === 'moduleId[]') input.value = ''; // Clear moduleId on clone
          else input.value = '';
        });
        container.appendChild(clone);
        bindDeleteButtons();
      });

      bindDeleteButtons();
    });
  </script>
</body>